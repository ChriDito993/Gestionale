<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MASSOTERAPIA & PT di Christian Di Tommaso</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="cliente-dettaglio-page">

<div class="app-container">

    <header class="app-header">
        <h1>{{ cliente.nome }} {{ cliente.cognome }}</h1>
        <a href="/clienti" class="btn-primary">← Torna ai Clienti</a>
    </header>

    <!-- MINI DASHBOARD CLIENTE -->
    <div class="detail-card">
        <h3>Riepilogo Cliente</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;margin-top:15px;">
            <div>
                <p style="font-size:12px;color:#6b7280;text-transform:uppercase;">Sedute Totali</p>
                <p style="font-size:20px;font-weight:600;">{{ stats_totali or 0 }}</p>
            </div>
            <div>
                <p style="font-size:12px;color:#6b7280;text-transform:uppercase;">Sedute Rimanenti</p>
                <p style="font-size:20px;font-weight:600;">{{ stats_rimanenti or 0 }}</p>
            </div>
            <div>
                <p style="font-size:12px;color:#6b7280;text-transform:uppercase;">Ultima Visita</p>
                <p style="font-size:16px;font-weight:500;">{{ ultima_visita or '-' }}</p>
            </div>
            <div>
                <p style="font-size:12px;color:#6b7280;text-transform:uppercase;">Prossima Visita</p>
                <p style="font-size:16px;font-weight:500;">{{ prossima_visita or '-' }}</p>
            </div>
        </div>
    </div>

    <!-- CARD INFORMAZIONI -->
    <div class="detail-card">

        <div class="info-section">
            <p><strong>Telefono:</strong> {{ cliente.telefono or "-" }}</p>
            <p><strong>Email:</strong> {{ cliente.email or "-" }}</p>
            <p><strong>Data nascita:</strong> {{ cliente.data_nascita or "-" }}</p>
        </div>

        <button onclick="apriModificaCliente()" class="btn-primary" style="margin-top:15px;">
            Modifica Anagrafica
        </button>

        <hr>

        <h3>Note Cliniche</h3>

        <form method="POST" action="/cliente/{{ cliente.id }}/note">
            <textarea name="note_cliniche" rows="5">{{ cliente.note_cliniche or "" }}</textarea>
            <button class="btn-primary" type="submit">Salva Note</button>
        </form>

    </div>

    <!-- CARD PACCHETTI -->
    <div class="detail-card detail-card-packages">
        <h3>Assegna Nuovo Pacchetto</h3>

        <form method="POST" action="/assegna_pacchetto" class="package-form">
            <input type="hidden" name="cliente_id" value="{{ cliente.id }}">

            <select name="tipo_pacchetto_id" required class="input-apple">
                <option value="">Seleziona pacchetto</option>
                {% for pac in tipi_pacchetto %}
                    <option value="{{ pac.id }}">
                        {{ pac.nome }} ({{ pac.numero_sedute }} sedute)
                    </option>
                {% endfor %}
            </select>

            <button type="submit" class="btn-apple-primary package-submit-btn">Assegna Pacchetto</button>
        </form>
    </div>

    <!-- CARD PACCHETTI ATTIVI -->
    <div class="detail-card detail-card-packages">
        <h3>Pacchetti Attivi</h3>

        {% if pacchetti_cliente %}
            <ul class="pacchetti-list">
            {% for pac in pacchetti_cliente %}
            {% set tipo_pacchetto = pac.tipi_pacchetto or {} %}
            {% set sedute_totali = (tipo_pacchetto.numero_sedute or 0)|int %}
            {% set sedute_effettuate = (pac.sedute_effettuate or 0)|int %}
            {% set progress = ((sedute_effettuate * 100) / sedute_totali) if sedute_totali > 0 else 0 %}
            {% set progress_width = (progress if progress < 100 else 100)|round(0, 'floor') %}
            <li class="pacchetto-item">
                <div class="pacchetto-top-row">
                    <strong class="pacchetto-name">{{ tipo_pacchetto.nome or "Pacchetto" }}</strong>
                    <span class="pacchetto-restanti">Restanti: {{ pac.sedute_rimanenti or 0 }}</span>
                </div>

                <div class="pacchetto-progress-meta">
                    Sedute effettuate: {{ sedute_effettuate }} / {{ sedute_totali }}
                </div>

                <div class="pacchetto-progress-track">
                    <div class="pacchetto-progress-fill" data-width="{{ progress_width }}"></div>
                </div>

                <form method="POST" action="/chiudi_pacchetto/{{ pac.id }}" class="pacchetto-close-form">
                    <button type="submit" class="btn-danger-soft">Chiudi Pacchetto</button>
                </form>
            </li>
            {% endfor %}
            </ul>
        {% else %}
            <p class="detail-empty-state">Nessun pacchetto attivo.</p>
        {% endif %}
    </div>

    <!-- ========================= -->
    <!-- APPUNTAMENTI FUTURI -->
    <!-- ========================= -->
    <div class="detail-card">
        <h3>Appuntamenti Futuri</h3>

        {% if appuntamenti and appuntamenti|length > 0 %}
            <div class="cliente-app-section">
                {% for app in appuntamenti %}
                <div class="cliente-app-card future">
                    <div class="cliente-app-info">
                        <div class="cliente-app-date">{{ app.data_formattata }}</div>
                        <div class="cliente-app-service">
                            {{ app.servizio }}
                        </div>
                    </div>

                    <form method="POST" action="/update_stato" class="cliente-app-actions">
                        <input type="hidden" name="appuntamento_id" value="{{ app.id }}">

                        <select name="stato" class="input-apple status-select">
                            <option value="prenotato" {% if app.stato == "prenotato" %}selected{% endif %}>Prenotato</option>
                            <option value="completato" {% if app.stato == "completato" %}selected{% endif %}>Completato</option>
                            <option value="annullato" {% if app.stato == "annullato" %}selected{% endif %}>Annullato</option>
                        </select>

                        <button type="submit" class="btn-apple-primary btn-small">Salva</button>
                    </form>
                </div>
                {% endfor %}
            </div>

            <a href="/cliente/{{ cliente.id }}/promemoria"
               target="_blank"
               class="btn-primary" style="margin-top:20px; display:inline-block;">
                Genera PDF Promemoria
            </a>

        {% else %}
            <p class="detail-empty-state">Nessun appuntamento futuro.</p>
        {% endif %}
    </div>


    <!-- ========================= -->
    <!-- APPUNTAMENTI PASSATI -->
    <!-- ========================= -->
    <div class="detail-card">
        <div class="storico-toggle-wrapper">
            <h3>Storico Appuntamenti</h3>
            <button type="button"
                    class="storico-toggle-btn"
                    onclick="toggleStorico()">
                Mostra storico
            </button>
        </div>

        {% if storico_appuntamenti and storico_appuntamenti|length > 0 %}
            <div id="storicoSection" class="cliente-app-section storico-collapsed">
                {% for app in storico_appuntamenti %}
                <div class="cliente-app-card past">
                    <div class="cliente-app-info">
                        <div class="cliente-app-date">
                            {{ app.data_formattata }}
                        </div>

                        <div class="cliente-app-service">
                            {{ app.servizio }}

                            {% if app.numero_seduta %}
                                <span class="seduta-badge">
                                    Seduta {{ app.numero_seduta }}
                                </span>
                            {% endif %}
                        </div>
                    </div>

                    <form method="POST" action="/update_stato" class="cliente-app-actions">
                        <input type="hidden" name="appuntamento_id" value="{{ app.id }}">

                        <select name="stato" class="input-apple status-select">
                            <option value="prenotato" {% if app.stato == "prenotato" %}selected{% endif %}>Prenotato</option>
                            <option value="completato" {% if app.stato == "completato" %}selected{% endif %}>Completato</option>
                            <option value="annullato" {% if app.stato == "annullato" %}selected{% endif %}>Annullato</option>
                        </select>

                        <button type="submit" class="btn-apple-primary btn-small">Salva</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="detail-empty-state">Nessuno storico disponibile.</p>
        {% endif %}
    </div>

</div>

<!-- MODALE MODIFICA ANAGRAFICA -->
<div id="modificaClienteModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="chiudiModificaCliente()">✖</span>
        <h3>Modifica Anagrafica</h3>

        <input type="text" id="modNome" value="{{ cliente.nome or '' }}" placeholder="Nome">
        <input type="text" id="modCognome" value="{{ cliente.cognome or '' }}" placeholder="Cognome">
        <input type="text" id="modTelefono" value="{{ cliente.telefono or '' }}" placeholder="Telefono">
        <input type="email" id="modEmail" value="{{ cliente.email or '' }}" placeholder="Email">

        <button class="btn-primary" onclick="salvaModificaCliente('{{ cliente.id }}')">
            Salva Modifiche
        </button>
    </div>
</div>

<script>
function apriModificaCliente() {
    document.getElementById("modificaClienteModal").style.display = "block";
}

function chiudiModificaCliente() {
    document.getElementById("modificaClienteModal").style.display = "none";
}

function salvaModificaCliente(clienteId) {
    fetch("/api/clienti/" + clienteId, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            nome: document.getElementById("modNome").value,
            cognome: document.getElementById("modCognome").value,
            telefono: document.getElementById("modTelefono").value,
            email: document.getElementById("modEmail").value
        })
    })
    .then(res => res.json())
    .then(() => {
        location.reload();
    });
}

function toggleStorico() {
    const section = document.getElementById("storicoSection");
    const btn = document.querySelector(".storico-toggle-btn");

    if (!section) return;

    if (section.classList.contains("storico-collapsed")) {
        section.classList.remove("storico-collapsed");
        section.classList.add("storico-fade");
        btn.textContent = "Nascondi storico";
    } else {
        section.classList.add("storico-collapsed");
        btn.textContent = "Mostra storico";
    }
}
</script>

</body>
</html>
